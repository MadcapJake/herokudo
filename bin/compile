#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e
set -o pipefail   # don't ignore exit codes when piping output

indent() {
  sed -u 's/^/       /'
}
newstep() {
  echo "-----> $@"
}
substep() {
  echo "       $@"
}
newstep "Found a META6.json"

VER=2015.12

## Setting up dir
PERL6_DIR=$HOME/.heroku/perl6
mkdir -p $PERL6_DIR

LOG_FILE="/tmp/rakudo-build-log.txt"
: > $LOG_FILE

newstep "Installing MoarVM $VER"

substep "Downlading MoarVM..."
curl -0s http://moarvm.org/releases/MoarVM-$VER.tar.gz | tar zxf -

substep "Configuring MoarVM..."
cd MoarVM-$VER
{ perl Configure.pl --prefix=$PERL6_DIR; } &> $LOG_FILE

substep "Installing MoarVM..."
make &> $LOG_FILE
make install &> $LOG_FILE

substep "Cleaning up..."
cd ..
rm -rf MoarVM-$VER

newstep "Installing NQP $VER"

substep "Downlading NQP..."
curl -s http://rakudo.org/downloads/nqp/nqp-$VER.tar.gz | tar zxf -

substep "Configuring NQP..."
cd nqp-$VER
{ perl Configure.pl --prefix=$PERL6_DIR; } &> $LOG_FILE

substep "Installing NQP..."
make &> $LOG_FILE
make install &> $LOG_FILE

substep "Cleaning up..."
cd ..
rm -rf nqp-$ver

newstep "Installing Rakudo $VER"

substep "Downlading Rakudo..."
curl -s http://rakudo.org/downloads/rakudo/rakudo-$VER.tar.gz | tar zxf -

substep "Configuring Rakudo..."
cd rakudo-$VER
{ perl Configure.pl --backends=moar --prefix=$PERL6_DIR; } &> $LOG_FILE

substep "Installing Rakudo..."
make &> $LOG_FILE
make install &> $LOG_FILE
PERL6_BIN=$PERL6_DIR/bin
export PATH=$PERL6_BIN:$PATH

substep "Cleaning up..."
cd ..
rm -rf rakudo-$VER

newstep "Installing Panda's latest"

substep "Cloning Panda..."
git clone --recursive git://github.com/tadzik/panda.git -q

substep "Boostrapping Panda..."
cd panda
{ perl6 bootstrap.pl; } &> $LOG_FILE
SITE_BIN=$HOME/.heroku/perl6/share/perl6/site/bin
export PATH=$SITE_BIN:$PATH

substep "Cleaning up..."
cd ..
rm -rf panda

newstep "Installing Task::Star"

substep "Panda installing..."
{ panda install Task::Star; } &> $LOG_FILE

# BUILD_DIR=${1:-}
# CACHE_DIR=${2:-}
# # ENV_DIR=${3:-}
# # BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

mkdir -p $BUILD_DIR/.profile.d
echo "PATH=$PERL6_BIN:$SITE_BIN:$PATH" > $BUILD_DIR/.profile.d/perl6.sh
