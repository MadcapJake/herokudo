#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e
set -o pipefail   # don't ignore exit codes when piping output

indent() {
  sed -u 's/^/       /'
}

echo "-----> Found a META6.json"

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
# ENV_DIR=${3:-}
# BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)
RAKUDOBREW_BIN=/app/.heroku/rakudobrew/bin
SITE_BIN=/app/.heroku/rakudobrew/moar-nom/install/share/perl6/site/bin

mkdir -p $BUILD_DIR/.heroku/rakudobrew
mkdir -p /app/.heroku
ln -s $BUILD_DIR/.heroku/rakudobrew /app/.heroku/rakudobrew
export PATH=$RAKUDOBREW_BIN:$PATH

echo "-----> Cloning rakudobrew repo..."
git clone https://github.com/tadzik/rakudobrew $BUILD_DIR/.heroku/rakudobrew -q
echo "cloning completed" | indent

echo "-----> Initializing rakudobrew..."
rakudobrew init
echo "rakudobrew initialized" | indent

echo "-----> Building moar..."
rakudobrew build moar
echo "moar built" | indent

echo "-----> Building panda..."
rakudobrew build panda
echo "panda built" | indent

export PATH=$SITE_BIN:$PATH

echo "-----> Installing Task::Star..."
panda install Task::Star
echo "Task::Star modules installed" | indent

HOME_RBREW_BIN=$HOME/.heroku/rakudobrew/bin
HOME_RSITE_BIN=$HOME/.heroku/rakudobrew/moar-nom/install/share/perl6/site/bin
mkdir -p $BUILD_DIR/.profile.d
echo "PATH=$HOME_RBREW_BIN:$HOME_RSITE_BIN:$PATH" > $BUILD_DIR/.profile.d/perl6.sh
